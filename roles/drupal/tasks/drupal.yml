---
- name: Set Volumes Object (if code)
  set_fact:
    drupal_volume_mounts:
      - mountPath: "{{ code_pvc_mount_path }}"
        name: drupal-code
    drupal_volumes:
      - name: drupal-code
        persistentVolumeClaim:
          claimName: "{{ code_pvc_name }}"
  when: code_pvc_name is defined
- name: Set Volumes Object (if not code)
  set_fact:
    drupal_volume_mounts:
      - mountPath: "{{ settings_config_map_mount_path }}"
        name: drupal-settings
      - mountPath: "{{ files_pvc_mount_path }}"
        name: drupal-files
    drupal_volumes:
      - name: drupal-settings
        configMap:
          name: "{{ settings_config_map_name }}"
      - name: drupal-files
        persistentVolumeClaim:
          claimName: "{{ files_pvc_name }}"
  when: code_pvc_name is not defined
- name: Drupal Deployment.
  k8s:
    definition:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: '{{ ansible_operator_meta.name }}-drupal'
        namespace: '{{ ansible_operator_meta.namespace }}'
      spec:
        replicas: '{{ container_replicas }}'
        selector:
          matchLabels:
            app: '{{ ansible_operator_meta.name }}-drupal'
        template:
          metadata:
            labels:
              app: '{{ ansible_operator_meta.name }}-drupal'
          spec:
            containers:
              - name: drupal
                image: '{{ container_image }}'
                hostname: '{{ ingress_hostname }}'
                command: '{{ container_command | default(omit) }}'
                ports:
                  - containerPort: '{{ container_port }}'
                livenessProbe:
                  tcpSocket:
                    port: '{{ container_port }}'
                  initialDelaySeconds: 60
                readinessProbe:
                  tcpSocket:
                    port: '{{ container_port }}'
                  initialDelaySeconds: 30
                volumeMounts: "{{ drupal_volume_mounts }}"
            volumes: "{{ drupal_volumes }}"

- name: Drupal Service
  k8s:
    definition:
      kind: Service
      apiVersion: v1
      metadata:
        name: '{{ ansible_operator_meta.name }}'
        namespace: '{{ ansible_operator_meta.namespace }}'
      spec:
        type: NodePort
        ports:
          - port: '{{ container_port }}'
            targetPort: '{{ container_port }}'
        selector:
          app: '{{ ansible_operator_meta.name }}-drupal'

- name: Drupal Ingress
  k8s:
    state: "{{ 'present' if manage_ingress else 'absent' }}"
    definition:
      apiVersion: extensions/v1beta1
      kind: Ingress
      metadata:
        name: '{{ ansible_operator_meta.name }}'
        namespace: '{{ ansible_operator_meta.namespace }}'
      spec:
        rules:
          - host: '{{ ingress_hostname }}'
            http:
              paths:
                - path: /
                  backend:
                    serviceName: '{{ ansible_operator_meta.name }}'
                    servicePort: '{{ container_port }}'
